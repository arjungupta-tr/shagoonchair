---
import Layout from '../../layouts/Layout.astro';
import { AUTH_CONFIG } from '../../config/auth.js';
---

<Layout title="Create New Invoice - Shagoon Chair">
  <main>
    <div class="page-header">
      <h1>Create New  Invoice</h1>
      <div class="header-actions">
        <a href="/bills" class="btn btn-outline">‚Üê Back to Bills</a>
        <button onclick="logout()" class="btn btn-danger">üö™ Logout</button>
      </div>
    </div>

    <form id="invoiceForm" class="invoice-form">
      <div class="form-grid">
        <!-- Invoice Details Section -->
        <section class="form-section">
          <h2>üìã Invoice Details</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="bill_number">Invoice Number *</label>
              <div class="input-with-button">
                <input type="text" id="bill_number" name="bill_number" required placeholder="e.g., 710">
                <button type="button" onclick="generateBillNumber()" class="btn btn-secondary btn-sm">üîÑ Generate</button>
              </div>
            </div>
            <div class="form-group">
              <label for="invoice_date">Invoice Date *</label>
              <input type="date" id="invoice_date" name="invoice_date" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="challan_number">Challan Number</label>
              <input type="text" id="challan_number" name="challan_number" placeholder="e.g., CH-001">
            </div>
            <div class="form-group">
              <label for="challan_date">Challan Date</label>
              <input type="date" id="challan_date" name="challan_date">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="po_number">P.O. Number</label>
              <input type="text" id="po_number" name="po_number" placeholder="e.g., PO-2025-001">
            </div>
            <div class="form-group">
              <label for="po_date">P.O. Date</label>
              <input type="date" id="po_date" name="po_date">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="vendor_code">Vendor Code</label>
              <input type="text" id="vendor_code" name="vendor_code" placeholder="e.g., VEN001">
            </div>
            <div class="form-group">
              <label for="hsn_code">HSN Code</label>
              <input type="text" id="hsn_code" name="hsn_code" placeholder="e.g., 9403">
            </div>
          </div>
          <div class="form-group">
            <label for="dispatch_details">Dispatch Details</label>
            <textarea id="dispatch_details" name="dispatch_details" rows="2" placeholder="e.g., Dispatched through XYZ Transport, Vehicle No. MH-01-AB-1234"></textarea>
          </div>
        </section>

        <!-- Customer Details Section -->
        <section class="form-section">
          <h2>üë§ Customer Details</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="customer_name">Customer Name *</label>
              <input type="text" id="customer_name" name="customer_name" required placeholder="e.g., M/S. CUPS AND MOULDS LLP.">
            </div>
            <div class="form-group">
              <label for="customer_code">Customer Code</label>
              <input type="number" id="customer_code" name="customer_code" placeholder="e.g., 1001">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="customer_phone">Phone Number *</label>
              <input type="tel" id="customer_phone" name="customer_phone" required placeholder="+91 9820732807">
            </div>
            <div class="form-group">
              <label for="customer_email">Email</label>
              <input type="email" id="customer_email" name="customer_email" placeholder="customer@example.com">
            </div>
          </div>
          <div class="form-group">
            <label for="customer_address">Customer Address *</label>
            <textarea id="customer_address" name="customer_address" required rows="3" placeholder="Complete billing address"></textarea>
          </div>
          <div class="form-group">
            <label for="customer_gst_number">Customer GST Number</label>
            <input type="text" id="customer_gst_number" name="customer_gst_number" placeholder="27AAQFC3444C1ZK">
          </div>
        </section>
      </div>

      <!-- Items Section -->
      <section class="form-section">
        <h2>üõçÔ∏è Invoice Items</h2>
        <div class="items-container">
          <div class="items-header">
            <span>Sr. No</span>
            <span>Description</span>
            <span>Unit Price (‚Çπ)</span>
            <span>Qty</span>
            <span>Amount (‚Çπ)</span>
            <span>Action</span>
          </div>
          <div id="itemsList">
            <!-- Items will be dynamically added here -->
          </div>
          <button type="button" id="addItemBtn" class="btn btn-success">+ Add Item</button>
        </div>
      </section>

      <!-- Tax & Payment Section -->
      <div class="form-grid">
        <section class="form-section">
          <h2>üí∞ Tax Calculation</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="cgst_percentage">CGST % *</label>
              <input type="number" id="cgst_percentage" name="cgst_percentage" value="9" step="0.01" required>
            </div>
            <div class="form-group">
              <label for="sgst_percentage">SGST % *</label>
              <input type="number" id="sgst_percentage" name="sgst_percentage" value="9" step="0.01" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="igst_percentage">IGST %</label>
              <input type="number" id="igst_percentage" name="igst_percentage" value="0" step="0.01">
            </div>
            <div class="form-group">
              <label for="discount_percentage">Discount %</label>
              <input type="number" id="discount_percentage" name="discount_percentage" value="0" step="0.01">
            </div>
          </div>
          
          <div class="calculation-summary">
            <div class="calc-row">
              <span>Subtotal:</span>
              <span id="subtotalDisplay">‚Çπ0.00</span>
            </div>
            <div class="calc-row">
              <span>CGST:</span>
              <span id="cgstDisplay">‚Çπ0.00</span>
            </div>
            <div class="calc-row">
              <span>SGST:</span>
              <span id="sgstDisplay">‚Çπ0.00</span>
            </div>
            <div class="calc-row">
              <span>IGST:</span>
              <span id="igstDisplay">‚Çπ0.00</span>
            </div>
            <div class="calc-row">
              <span>Discount:</span>
              <span id="discountDisplay">‚Çπ0.00</span>
            </div>
            <div class="calc-row total-row">
              <span><strong>Total Amount:</strong></span>
              <span id="totalDisplay"><strong>‚Çπ0.00</strong></span>
            </div>
          </div>
        </section>

        <section class="form-section">
          <h2>üí≥ Payment Details</h2>
          <div class="form-group">
            <label for="payment_method">Payment Method *</label>
            <select id="payment_method" name="payment_method" required>
              <option value="cash">Cash</option>
              <option value="card">Card</option>
              <option value="upi">UPI</option>
              <option value="bank_transfer">Bank Transfer</option>
              <option value="cheque">Cheque</option>
              <option value="dd">Demand Draft</option>
            </select>
          </div>
          <div class="form-group">
            <label for="payment_status">Payment Status *</label>
            <select id="payment_status" name="payment_status" required>
              <option value="pending">Pending</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <div class="form-group">
            <label for="payment_terms">Payment Terms</label>
            <textarea id="payment_terms" name="payment_terms" rows="2">PAYMENT ONLY BY CROSSED CHEQUES / DD PAYABLE IN MUMBAI</textarea>
          </div>
        </section>
      </div>

      <!-- Bank Details Section -->
      <section class="form-section">
        <h2>üè¶ Bank Details</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="bank_name">Bank Name</label>
            <input type="text" id="bank_name" name="bank_name" value="INDIAN BANK">
          </div>
          <div class="form-group">
            <label for="bank_account_number">Account Number</label>
            <input type="text" id="bank_account_number" name="bank_account_number" value="641205735S">
          </div>
          <div class="form-group">
            <label for="bank_branch">Branch</label>
            <input type="text" id="bank_branch" name="bank_branch" value="MALAD EAST">
          </div>
          <div class="form-group">
            <label for="bank_ifsc_code">IFSC Code</label>
            <input type="text" id="bank_ifsc_code" name="bank_ifsc_code" value="IDIB000M202">
          </div>
          <div class="form-group">
            <label for="bank_account_type">Account Type</label>
            <input type="text" id="bank_account_type" name="bank_account_type" value="CURRENT A/C">
          </div>
        </div>
      </section>

      <!-- Notes Section -->
      <section class="form-section">
        <h2>üìù Additional Notes</h2>
        <div class="form-group">
          <label for="notes">Notes</label>
          <textarea id="notes" name="notes" rows="3" placeholder="Any additional notes or comments"></textarea>
        </div>
      </section>

      <!-- Terms and Conditions Section -->
      <section class="form-section">
        <h2>üìã Terms and Conditions</h2>
        <div class="form-group">
          <label for="terms_and_conditions">Terms and Conditions</label>
          <textarea id="terms_and_conditions" name="terms_and_conditions" rows="6">‚Ä¢ Price including Fabric/guts-Tax per Mtr. Party will have to give Two alternative.
‚Ä¢ Inspection prior to dispatch if desire will be at our factory premises.
‚Ä¢ 50% advance with confirm order & balance against delivery.
‚Ä¢ Warranty period 12 Months against manufacturing defect.
‚Ä¢ Payment of the bill must every month of 15th.
‚Ä¢ Interest will be charged @ 20% on all accounts remaining unpaid after credit time.</textarea>
        </div>
      </section>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="submit" class="btn btn-primary" id="submitBtn">üí∞ Create Invoice</button>
        <button type="reset" class="btn btn-outline">üîÑ Reset Form</button>
      </div>
    </form>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-content">
        <div class="spinner"></div>
        <p>Creating Invoice...</p>
      </div>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="message-box">
      <div class="message-content">
        <div class="message-header">
          <span id="messageTitle">Message</span>
          <button id="messageClose" class="message-close">√ó</button>
        </div>
        <div class="message-body">
          <div id="messageIcon" class="message-icon"></div>
          <div id="messageText" class="message-text"></div>
        </div>
        <div class="message-actions">
          <button id="messageOk" class="btn btn-primary">OK</button>
          <button id="messageCancel" class="btn btn-outline" style="display: none;">Cancel</button>
        </div>
      </div>
    </div>
  </main>
</Layout>

<style>
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  .page-header h1 {
    margin: 0;
    color: #2c3e50;
  }

  .header-actions {
    display: flex;
    gap: 10px;
  }

  .invoice-form {
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
  }

  .form-section {
    margin-bottom: 30px;
  }

  .form-section h2 {
    color: #2c3e50;
    border-bottom: 2px solid #3498db;
    padding-bottom: 10px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #2c3e50;
  }

  .form-group input,
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.3s ease;
  }

  .form-group input:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
  }

  .items-container {
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 20px;
  }

  .items-header {
    display: grid;
    grid-template-columns: 80px 1fr 150px 120px 150px 100px;
    gap: 15px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 15px 20px;
    font-weight: 600;
    font-size: 14px;
    border-bottom: 2px solid #dee2e6;
    text-align: center;
    color: #495057;
    align-items: center;
  }

  .item-row {
    display: grid !important;
    grid-template-columns: 80px 1fr 150px 120px 150px 100px !important;
    gap: 15px !important;
    padding: 15px 20px !important;
    border-bottom: 1px solid #f1f3f4 !important;
    align-items: center !important;
    background: white !important;
    transition: background-color 0.2s ease;
  }

  .item-row:hover {
    background: #fafbfc;
  }

  .item-row:last-child {
    border-bottom: none;
  }

  .item-row input,
  .item-row select {
    padding: 12px !important;
    border: 1px solid #dee2e6 !important;
    border-radius: 6px !important;
    font-size: 14px !important;
    font-weight: 500 !important;
    transition: all 0.3s ease !important;
    background: white !important;
    color: #495057 !important;
    width: 100% !important;
    box-sizing: border-box !important;
  }

  .item-row input:focus,
  .item-row select:focus {
    outline: none !important;
    border-color: #3498db !important;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1) !important;
    background: #fff !important;
  }

  .item-row input::placeholder {
    color: #adb5bd !important;
    font-weight: 400 !important;
  }

  .item-total {
    font-weight: 600 !important;
    font-size: 15px !important;
    color: #27ae60 !important;
    text-align: center !important;
    padding: 12px 8px !important;
    background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%) !important;
    border-radius: 6px !important;
    border: 1px solid #d4edda !important;
    min-width: 100px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  .sr-no {
    font-weight: 600 !important;
    font-size: 16px !important;
    color: #3498db !important;
    text-align: center !important;
    background: linear-gradient(135deg, #f8fbff 0%, #e3f2fd 100%) !important;
    padding: 8px !important;
    border-radius: 6px !important;
    border: 1px solid #e3f2fd !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  .calculation-summary {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    margin-top: 15px;
  }

  .calc-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding: 4px 0;
  }

  .total-row {
    border-top: 2px solid #3498db;
    padding-top: 8px;
    margin-top: 10px;
    font-size: 16px;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    text-decoration: none;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary {
    background: #3498db;
    color: white;
  }

  .btn-secondary {
    background: #95a5a6;
    color: white;
  }

  .btn-success {
    background: #27ae60;
    color: white;
  }

  .btn-danger {
    background: #e74c3c;
    color: white;
  }

  .btn-outline {
    background: transparent;
    color: #2c3e50;
    border: 1px solid #2c3e50;
  }

  .btn-sm {
    padding: 6px 12px;
    font-size: 12px;
  }

  .input-with-button {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .input-with-button input {
    flex: 1;
  }

  .input-with-button .btn {
    white-space: nowrap;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  .form-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    padding-top: 20px;
    border-top: 1px solid #eee;
  }

  .remove-item {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    border: none;
    padding: 10px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(231, 76, 60, 0.2);
  }

  .remove-item:hover {
    background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
  }

  .btn.btn-success {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    color: white;
    padding: 12px 24px;
    margin-top: 15px;
    font-weight: 600;
    box-shadow: 0 3px 6px rgba(39, 174, 96, 0.2);
    transition: all 0.3s ease;
  }

  .btn.btn-success:hover:not(:disabled) {
    background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(39, 174, 96, 0.3);
  }

  .btn.btn-success:disabled {
    background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%) !important;
    cursor: not-allowed !important;
    opacity: 0.6 !important;
    transform: none !important;
    box-shadow: 0 2px 4px rgba(149, 165, 166, 0.2) !important;
  }

  .btn.btn-success:disabled:hover {
    transform: none !important;
    box-shadow: 0 2px 4px rgba(149, 165, 166, 0.2) !important;
  }

  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      gap: 15px;
      text-align: center;
    }

    .form-grid {
      grid-template-columns: 1fr;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .items-header {
      display: none; /* Hide header on mobile for better space usage */
    }

    .item-row {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 20px;
      border: 1px solid #dee2e6;
      margin-bottom: 15px;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .item-row:hover {
      background: #fafbfc;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }

    .item-row input {
      width: 100%;
      padding: 14px;
      font-size: 16px; /* Prevent zoom on iOS */
    }

    .item-row .sr-no {
      font-weight: 600;
      font-size: 18px;
      color: #3498db;
      text-align: center;
      padding: 12px;
      background: linear-gradient(135deg, #f8fbff 0%, #e3f2fd 100%);
      border-radius: 8px;
      border: 1px solid #e3f2fd;
    }

    .item-row .item-total {
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      padding: 15px;
      background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
      border-radius: 8px;
      border: 1px solid #d4edda;
      color: #27ae60;
    }

    .remove-item {
      padding: 12px 16px;
      font-size: 16px;
      align-self: center;
      width: fit-content;
    }

    .form-actions {
      flex-direction: column;
    }
  }

  /* Loading Overlay */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(4px);
  }

  .loading-overlay.show {
    display: flex;
  }

  .loading-content {
    background: white;
    padding: 40px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    min-width: 300px;
  }

  .spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .loading-content p {
    margin: 0;
    font-size: 16px;
    color: #2c3e50;
    font-weight: 500;
  }

  /* Message Box */
  .message-box {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
  }

  .message-box.show {
    display: flex;
  }

  .message-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    min-width: 400px;
    max-width: 500px;
    overflow: hidden;
    animation: messageSlideIn 0.3s ease-out;
  }

  @keyframes messageSlideIn {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .message-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 20px 25px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .message-header span {
    font-weight: 600;
    font-size: 18px;
    color: #2c3e50;
  }

  .message-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #6c757d;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
  }

  .message-close:hover {
    background: #e9ecef;
    color: #495057;
  }

  .message-body {
    padding: 30px 25px;
    display: flex;
    align-items: flex-start;
    gap: 20px;
  }

  .message-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
  }

  .message-icon.success {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724;
  }

  .message-icon.success::before {
    content: "‚úì";
  }

  .message-icon.error {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24;
  }

  .message-icon.error::before {
    content: "‚úï";
  }

  .message-icon.warning {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #856404;
  }

  .message-icon.warning::before {
    content: "‚ö†";
  }

  .message-icon.info {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    color: #0c5460;
  }

  .message-icon.info::before {
    content: "‚Ñπ";
  }

  .message-text {
    flex: 1;
    font-size: 16px;
    line-height: 1.5;
    color: #495057;
  }

  .message-actions {
    padding: 20px 25px;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    background: #f8f9fa;
  }

  .message-actions .btn {
    min-width: 80px;
  }

  @media (max-width: 768px) {
    .message-content {
      min-width: auto;
      max-width: 90%;
      margin: 20px;
    }

    .loading-content {
      min-width: auto;
      max-width: 90%;
      margin: 20px;
      padding: 30px 20px;
    }
  }
</style>

<script define:vars={{ AUTH_CONFIG }}>
  // Message box and loader functions
  function showLoader(message = 'Processing...') {
    const overlay = document.getElementById('loadingOverlay');
    const text = overlay.querySelector('p');
    text.textContent = message;
    overlay.classList.add('show');
    
    // Disable form submission button
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.style.opacity = '0.6';
      submitBtn.style.cursor = 'not-allowed';
    }
  }

  function hideLoader() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.remove('show');
    
    // Re-enable form submission button
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.style.opacity = '1';
      submitBtn.style.cursor = 'pointer';
    }
  }

  function showMessage(type, title, message, showCancel = false) {
    return new Promise((resolve) => {
      const messageBox = document.getElementById('messageBox');
      const messageTitle = document.getElementById('messageTitle');
      const messageIcon = document.getElementById('messageIcon');
      const messageText = document.getElementById('messageText');
      const messageOk = document.getElementById('messageOk');
      const messageCancel = document.getElementById('messageCancel');
      const messageClose = document.getElementById('messageClose');
      
      // Set content
      messageTitle.textContent = title;
      messageText.textContent = message;
      
      // Set icon type
      messageIcon.className = `message-icon ${type}`;
      
      // Show/hide cancel button
      if (showCancel) {
        messageCancel.style.display = 'inline-flex';
        messageOk.textContent = 'Yes';
        messageCancel.textContent = 'No';
      } else {
        messageCancel.style.display = 'none';
        messageOk.textContent = 'OK';
      }
      
      // Show message box
      messageBox.classList.add('show');
      
      // Handle button clicks
      function handleOk() {
        messageBox.classList.remove('show');
        cleanup();
        resolve(true);
      }
      
      function handleCancel() {
        messageBox.classList.remove('show');
        cleanup();
        resolve(false);
      }
      
      function handleClose() {
        messageBox.classList.remove('show');
        cleanup();
        resolve(false);
      }
      
      function cleanup() {
        messageOk.removeEventListener('click', handleOk);
        messageCancel.removeEventListener('click', handleCancel);
        messageClose.removeEventListener('click', handleClose);
      }
      
      // Add event listeners
      messageOk.addEventListener('click', handleOk);
      messageCancel.addEventListener('click', handleCancel);
      messageClose.addEventListener('click', handleClose);
      
      // Handle escape key
      function handleEscape(e) {
        if (e.key === 'Escape') {
          messageBox.classList.remove('show');
          cleanup();
          document.removeEventListener('keydown', handleEscape);
          resolve(false);
        }
      }
      
      document.addEventListener('keydown', handleEscape);
    });
  }

  // Check authentication on page load
  document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem(AUTH_CONFIG.SESSION_KEY) !== 'true') {
      window.location.href = AUTH_CONFIG.REDIRECT_PATHS.LOGIN;
      return;
    }
  });

  let itemCounter = 0;
  const MAX_ITEMS = 15;

  function addItem() {
    // Check if we've reached the maximum number of items
    const currentItemCount = document.querySelectorAll('.item-row').length;
    
    if (currentItemCount >= MAX_ITEMS) {
      showMessage('warning', 'Item Limit Reached', `You can only add a maximum of ${MAX_ITEMS} items to an invoice.`);
      console.log('Maximum item limit reached:', currentItemCount);
      return;
    }
    
    itemCounter++;
    console.log('Adding item #', itemCounter, `(${currentItemCount + 1}/${MAX_ITEMS})`);
    
    const itemsList = document.getElementById('itemsList');
    const itemRow = document.createElement('div');
    itemRow.className = 'item-row';
    itemRow.dataset.itemId = itemCounter; // Add data attribute for tracking
    itemRow.style.cssText = `
      display: grid !important;
      grid-template-columns: 80px 1fr 150px 120px 150px 100px !important;
      gap: 15px !important;
      padding: 15px 20px !important;
      border-bottom: 1px solid #f1f3f4 !important;
      align-items: center !important;
      background: white !important;
      transition: background-color 0.2s ease;
    `;
    
    itemRow.innerHTML = `
      <span class="sr-no" style="
        font-weight: 600 !important;
        font-size: 16px !important;
        color: #3498db !important;
        text-align: center !important;
        background: linear-gradient(135deg, #f8fbff 0%, #e3f2fd 100%) !important;
        padding: 8px !important;
        border-radius: 6px !important;
        border: 1px solid #e3f2fd !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      ">${itemCounter}</span>
      <input type="text" name="items[${itemCounter}][product_description]" placeholder="Item description" required
        class="item-description"
        style="
          padding: 12px !important;
          border: 1px solid #dee2e6 !important;
          border-radius: 6px !important;
          font-size: 14px !important;
          font-weight: 500 !important;
          transition: all 0.3s ease !important;
          background: white !important;
          color: #495057 !important;
          width: 100% !important;
          box-sizing: border-box !important;
        ">
      <input type="number" name="items[${itemCounter}][unit_price]" placeholder="0.00" step="0.01" min="0" required
        class="item-unit-price"
        style="
          padding: 12px !important;
          border: 1px solid #dee2e6 !important;
          border-radius: 6px !important;
          font-size: 14px !important;
          font-weight: 500 !important;
          transition: all 0.3s ease !important;
          background: white !important;
          color: #495057 !important;
          width: 100% !important;
          box-sizing: border-box !important;
        ">
      <input type="number" name="items[${itemCounter}][quantity]" placeholder="0" min="1" required
        class="item-quantity"
        style="
          padding: 12px !important;
          border: 1px solid #dee2e6 !important;
          border-radius: 6px !important;
          font-size: 14px !important;
          font-weight: 500 !important;
          transition: all 0.3s ease !important;
          background: white !important;
          color: #495057 !important;
          width: 100% !important;
          box-sizing: border-box !important;
        ">
      <span class="item-total" style="
        font-weight: 600 !important;
        font-size: 15px !important;
        color: #27ae60 !important;
        text-align: center !important;
        padding: 12px 8px !important;
        background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%) !important;
        border-radius: 6px !important;
        border: 1px solid #d4edda !important;
        min-width: 100px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      ">‚Çπ0.00</span>
      <button type="button" class="remove-item" style="
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
        color: white !important;
        border: none !important;
        padding: 10px 12px !important;
        border-radius: 6px !important;
        cursor: pointer !important;
        font-size: 14px !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 4px rgba(231, 76, 60, 0.2) !important;
      ">‚úï</button>
    `;
    
    itemsList.appendChild(itemRow);
    
    // Setup event listeners for this specific row - CRITICAL: This must be called after the HTML is in the DOM
    console.log('Setting up event listeners for new item row');
    setupItemRowEventListeners(itemRow);
    
    // Update the Add Item button text and state
    updateAddItemButton();
    
    // Initial calculation
    calculateTotals();
    
    console.log('Item added successfully');
  }

  function updateAddItemButton() {
    const addItemBtn = document.getElementById('addItemBtn');
    const currentItemCount = document.querySelectorAll('.item-row').length;
    
    if (addItemBtn) {
      if (currentItemCount >= MAX_ITEMS) {
        addItemBtn.textContent = `Maximum ${MAX_ITEMS} Items Reached`;
        addItemBtn.disabled = true;
        addItemBtn.style.opacity = '0.6';
        addItemBtn.style.cursor = 'not-allowed';
        addItemBtn.style.background = 'linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%)';
      } else {
        addItemBtn.textContent = `+ Add Item (${currentItemCount}/${MAX_ITEMS})`;
        addItemBtn.disabled = false;
        addItemBtn.style.opacity = '1';
        addItemBtn.style.cursor = 'pointer';
        addItemBtn.style.background = 'linear-gradient(135deg, #27ae60 0%, #229954 100%)';
      }
    }
  }

  function removeItem(button) {
    const itemRow = button.parentElement;
    itemRow.remove();
    
    // Renumber all items
    renumberItems();
    
    // Update the Add Item button state
    updateAddItemButton();
    
    calculateTotals();
  }

  function validateNumericInput(input) {
    // Ensure numeric inputs have valid values
    if (input.type === 'number' || input.name.includes('price') || input.name.includes('quantity') || input.name.includes('percentage')) {
      let value = parseFloat(input.value);
      if (isNaN(value) || value < 0) {
        input.value = '';
        return 0;
      }
      // Format to 2 decimal places for price fields
      if (input.name.includes('price')) {
        input.value = value.toFixed(2);
      }
      return value;
    }
    return input.value;
  }

  function setupItemRowEventListeners(itemRow) {
    const unitPriceInput = itemRow.querySelector('.item-unit-price');
    const quantityInput = itemRow.querySelector('.item-quantity');
    const removeBtn = itemRow.querySelector('.remove-item');
    
    console.log('Setting up listeners for row:', itemRow);
    console.log('Found inputs:', { unitPriceInput, quantityInput, removeBtn });
    
    if (unitPriceInput) {
      // Remove existing listeners to prevent duplicates
      const newChangeHandler = function() {
        console.log('Unit price changed:', this.value);
        validateNumericInput(this);
        calculateItemTotalByRow(itemRow);
      };
      
      const newInputHandler = function() {
        console.log('Unit price input:', this.value);
        calculateItemTotalByRow(itemRow);
      };
      
      const newBlurHandler = function() {
        validateNumericInput(this);
      };
      
      unitPriceInput.addEventListener('change', newChangeHandler);
      unitPriceInput.addEventListener('input', newInputHandler);
      unitPriceInput.addEventListener('blur', newBlurHandler);
    }
    
    if (quantityInput) {
      const newChangeHandler = function() {
        console.log('Quantity changed:', this.value);
        validateNumericInput(this);
        calculateItemTotalByRow(itemRow);
      };
      
      const newInputHandler = function() {
        console.log('Quantity input:', this.value);
        calculateItemTotalByRow(itemRow);
      };
      
      const newBlurHandler = function() {
        validateNumericInput(this);
      };
      
      quantityInput.addEventListener('change', newChangeHandler);
      quantityInput.addEventListener('input', newInputHandler);
      quantityInput.addEventListener('blur', newBlurHandler);
    }
    
    if (removeBtn) {
      const newClickHandler = function() {
        console.log('Remove button clicked');
        removeItem(this);
      };
      
      removeBtn.addEventListener('click', newClickHandler);
    }
  }

  function renumberItems() {
    const itemRows = document.querySelectorAll('.item-row');
    console.log('Renumbering', itemRows.length, 'items');
    
    itemRows.forEach((row, index) => {
      const srNoSpan = row.querySelector('.sr-no');
      if (srNoSpan) {
        srNoSpan.textContent = index + 1;
      }
      
      // Update input names to maintain proper indexing
      const inputs = row.querySelectorAll('input');
      inputs.forEach(input => {
        if (input.name) {
          input.name = input.name.replace(/\[\d+\]/, `[${index + 1}]`);
        }
      });
      
      // Update data attributes
      row.dataset.itemId = index + 1;
      
      // Re-setup event listeners for this row
      setupItemRowEventListeners(row);
    });
    
    // Update itemCounter to match the actual number of items
    itemCounter = itemRows.length;
    console.log('Updated itemCounter to:', itemCounter);
    
    // Update the Add Item button state
    updateAddItemButton();
  }

  function calculateItemTotalByRow(itemRow) {
    const unitPriceInput = itemRow.querySelector('.item-unit-price');
    const quantityInput = itemRow.querySelector('.item-quantity');
    const totalSpan = itemRow.querySelector('.item-total');
    
    if (unitPriceInput && quantityInput && totalSpan) {
      const unitPrice = parseFloat(unitPriceInput.value) || 0;
      const quantity = parseFloat(quantityInput.value) || 0;
      const total = unitPrice * quantity;
      
      totalSpan.textContent = `‚Çπ${total.toFixed(2)}`;
      
      console.log('Calculated item total:', {
        unitPrice,
        quantity,
        total: total.toFixed(2)
      });
      
      // Trigger overall calculations
      calculateTotals();
    }
  }

  function calculateItemTotal(itemId) {
    const unitPriceInput = document.querySelector(`input[name="items[${itemId}][unit_price]"]`);
    const quantityInput = document.querySelector(`input[name="items[${itemId}][quantity]"]`);
    const totalSpan = document.getElementById(`itemTotal${itemId}`);
    
    if (unitPriceInput && quantityInput && totalSpan) {
      const unitPrice = parseFloat(unitPriceInput.value) || 0;
      const quantity = parseFloat(quantityInput.value) || 0; // Changed to parseFloat for decimal quantities
      const total = unitPrice * quantity;
      
      totalSpan.textContent = `‚Çπ${total.toFixed(2)}`;
      
      // Trigger overall calculations after a short delay to ensure DOM updates
      setTimeout(() => calculateTotals(), 10);
    }
  }

  function calculateTotals() {
    let subtotal = 0;
    const itemTotals = [];
    
    // Calculate subtotal from all item totals
    document.querySelectorAll('.item-total').forEach((element, index) => {
      // Extract numeric value from display text
      const valueText = element.textContent.replace('‚Çπ', '').replace(',', '').trim();
      const value = parseFloat(valueText) || 0;
      subtotal += value;
      itemTotals.push({ index: index + 1, value, text: valueText });
    });

    console.log('Calculate Totals Debug:', {
      itemTotals,
      subtotal
    });

    // Get tax and discount percentages
    const cgstPercentage = parseFloat(document.getElementById('cgst_percentage')?.value) || 0;
    const sgstPercentage = parseFloat(document.getElementById('sgst_percentage')?.value) || 0;
    const igstPercentage = parseFloat(document.getElementById('igst_percentage')?.value) || 0;
    const discountPercentage = parseFloat(document.getElementById('discount_percentage')?.value) || 0;

    // Calculate amounts
    const cgstAmount = (subtotal * cgstPercentage) / 100;
    const sgstAmount = (subtotal * sgstPercentage) / 100;
    const igstAmount = (subtotal * igstPercentage) / 100;
    const discountAmount = (subtotal * discountPercentage) / 100;
    
    const totalAmount = subtotal + cgstAmount + sgstAmount + igstAmount - discountAmount;

    // Update display elements with proper error handling
    const updateElement = (id, value) => {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = `‚Çπ${value.toFixed(2)}`;
      } else {
        console.warn(`Element with ID '${id}' not found`);
      }
    };

    updateElement('subtotalDisplay', subtotal);
    updateElement('cgstDisplay', cgstAmount);
    updateElement('sgstDisplay', sgstAmount);
    updateElement('igstDisplay', igstAmount);
    updateElement('discountDisplay', discountAmount);
    updateElement('totalDisplay', totalAmount);
    
    // Log calculation for debugging
    console.log('Final Calculation:', {
      subtotal: subtotal.toFixed(2),
      cgstAmount: cgstAmount.toFixed(2),
      sgstAmount: sgstAmount.toFixed(2),
      igstAmount: igstAmount.toFixed(2),
      discountAmount: discountAmount.toFixed(2),
      totalAmount: totalAmount.toFixed(2)
    });
  }

  // Add event listeners for tax percentage changes
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - Setting up invoice form');
    
    // Set today's date
    document.getElementById('invoice_date').value = new Date().toISOString().split('T')[0];
    
    // Add one initial item
    addItem();

    // Add event listener for Add Item button
    const addItemBtn = document.getElementById('addItemBtn');
    if (addItemBtn) {
      addItemBtn.addEventListener('click', function() {
        console.log('Add Item button clicked');
        addItem();
      });
      console.log('Add Item button listener added');
    }

    // Add listeners for tax calculations with proper cleanup
    ['cgst_percentage', 'sgst_percentage', 'igst_percentage', 'discount_percentage'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        console.log('Setting up tax calculation listener for:', id);
        
        // Create handlers
        const changeHandler = function() {
          console.log(`${id} changed to:`, this.value);
          calculateTotals();
        };
        
        const inputHandler = function() {
          console.log(`${id} input:`, this.value);
          // Debounce input events for performance
          clearTimeout(this._inputTimeout);
          this._inputTimeout = setTimeout(calculateTotals, 100);
        };
        
        element.addEventListener('change', changeHandler);
        element.addEventListener('input', inputHandler);
        
        console.log(`Tax calculation listeners added for ${id}`);
      } else {
        console.warn(`Element with ID '${id}' not found`);
      }
    });
    
    // Initial calculation and button state
    console.log('Running initial calculation');
    calculateTotals();
    updateAddItemButton();
    
    console.log('Invoice form setup complete');
  });

  // Form submission
  document.getElementById('invoiceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Show loader
    showLoader('Creating Invoice...');
    
    try {
      // Collect form data
      const formData = new FormData(this);
      const invoiceData = Object.fromEntries(formData.entries());
      
      // Collect items data with simplified structure
      const items = [];
      const itemRows = document.querySelectorAll('.item-row');
      
      // Check item limit before processing
      if (itemRows.length > MAX_ITEMS) {
        hideLoader();
        await showMessage('error', 'Too Many Items', `You can only submit a maximum of ${MAX_ITEMS} items. Please remove some items before submitting.`);
        return;
      }
      
      itemRows.forEach((row, index) => {
        const descriptionInput = row.querySelector('input[name*="product_description"]');
        const unitPriceInput = row.querySelector('input[name*="unit_price"]');
        const quantityInput = row.querySelector('input[name*="quantity"]');
        
        if (descriptionInput && descriptionInput.value.trim()) {
          const unitPrice = parseFloat(unitPriceInput.value) || 0;
          const quantity = parseInt(quantityInput.value) || 0;
          const totalPrice = unitPrice * quantity;
          
          const item = {
            sr_no: index + 1,
            product_name: descriptionInput.value.trim(), // Map description to product_name for backend compatibility
            product_description: descriptionInput.value.trim(),
            product_category: 'General', // Default category
            hsn_code: '', // Default empty
            unit_price: unitPrice,
            quantity: quantity,
            total_price: totalPrice,
            unit: 'Nos' // Default unit
          };
          
          items.push(item);
        }
      });
      
      if (items.length === 0) {
        hideLoader();
        await showMessage('warning', 'Missing Items', 'Please add at least one item to the invoice.');
        return;
      }
      
      // Calculate totals
      const subtotal = items.reduce((sum, item) => sum + item.total_price, 0);
      const cgstPercentage = parseFloat(document.getElementById('cgst_percentage').value) || 0;
      const sgstPercentage = parseFloat(document.getElementById('sgst_percentage').value) || 0;
      const igstPercentage = parseFloat(document.getElementById('igst_percentage').value) || 0;
      const discountPercentage = parseFloat(document.getElementById('discount_percentage').value) || 0;
      
      const cgstAmount = (subtotal * cgstPercentage) / 100;
      const sgstAmount = (subtotal * sgstPercentage) / 100;
      const igstAmount = (subtotal * igstPercentage) / 100;
      const discountAmount = (subtotal * discountPercentage) / 100;
      const totalTaxAmount = cgstAmount + sgstAmount + igstAmount;
      const totalAmount = subtotal + totalTaxAmount - discountAmount;
      
      // Add calculated values to invoice data
      invoiceData.items = items;
      invoiceData.subtotal = subtotal;
      invoiceData.cgst_amount = cgstAmount;
      invoiceData.sgst_amount = sgstAmount;
      invoiceData.igst_amount = igstAmount;
      invoiceData.total_tax_amount = totalTaxAmount;
      invoiceData.discount_amount = discountAmount;
      invoiceData.total_amount = totalAmount;
      
      // Structure bank details properly
      invoiceData.bank_details = {
        bank_name: invoiceData.bank_name || '',
        account_number: invoiceData.bank_account_number || '',
        branch: invoiceData.bank_branch || '',
        ifsc_code: invoiceData.bank_ifsc_code || '',
        account_type: invoiceData.bank_account_type || ''
      };
      
      // Remove individual bank fields from the main object since they're now in bank_details
      delete invoiceData.bank_name;
      delete invoiceData.bank_account_number;
      delete invoiceData.bank_branch;
      delete invoiceData.bank_ifsc_code;
      delete invoiceData.bank_account_type;
      
      // Remove the flat item fields since we have the processed items array
      Object.keys(invoiceData).forEach(key => {
        if (key.startsWith('items[') && key.includes('][')) {
          delete invoiceData[key];
        }
      });
      
      invoiceData.created_at = new Date().toISOString();
      invoiceData.updated_at = new Date().toISOString();
      
      // Log the complete invoice data to verify all fields are included
      console.log('Invoice Data to be sent:', JSON.stringify(invoiceData, null, 2));
      console.log('Invoice Data size (bytes):', JSON.stringify(invoiceData).length);
      
      console.log('üîç Sending POST request to /api/bills...');
      
      const requestBody = JSON.stringify(invoiceData);
      console.log('üìã Request body size:', requestBody.length);
      console.log('üìã Request body preview:', requestBody.substring(0, 200) + '...');
      
      const response = await fetch('/api/bills', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: requestBody
      });
      
      console.log('üì• Response status:', response.status);
      console.log('üì• Response headers:', Object.fromEntries(response.headers.entries()));
      
      hideLoader(); // Hide loader before showing message
      
      if (response.ok) {
        const result = await response.json();
        console.log('‚úÖ Success response:', result);
        
        await showMessage('success', 'Success!', `Invoice #${result.billNumber} has been created successfully!`);
        window.location.href = '/bills';
      } else {
        const errorText = await response.text();
        console.error('‚ùå Error response text:', errorText);
        
        let errorData;
        try {
          errorData = JSON.parse(errorText);
        } catch {
          errorData = { error: 'Server returned non-JSON error', details: errorText };
        }
        
        console.error('‚ùå Error data:', errorData);
        
        // Handle specific error cases
        if (response.status === 409 && errorData.error === 'Bill number already exists') {
          const userChoice = await showMessage(
            'warning',
            'Duplicate Bill Number',
            `Bill number "${errorData.billNumber}" already exists. Would you like to generate a new unique bill number?`,
            true
          );
          
          if (userChoice) {
            await generateBillNumber();
            return; // Don't throw error, let user try again
          }
        } else {
          // Show error message
          await showMessage('error', 'Error', `Failed to create invoice: ${errorData.error || 'Unknown error'}`);
        }
      }
    } catch (error) {
      hideLoader();
      console.error('‚ùå Invoice creation error:', error);
      await showMessage('error', 'Error', `Error creating invoice: ${error.message}`);
    }
  });

  function logout() {
    localStorage.removeItem(AUTH_CONFIG.SESSION_KEY);
    showMessage('success', 'Logged Out', 'You have been logged out successfully.').then(() => {
      window.location.href = AUTH_CONFIG.REDIRECT_PATHS.LOGIN;
    });
  }

  async function generateBillNumber() {
    try {
      console.log('üîÑ Generating unique bill number...');
      
      const response = await fetch('/api/bills?action=generate-bill-number', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        const result = await response.json();
        document.getElementById('bill_number').value = result.billNumber;
        console.log('‚úÖ Generated bill number:', result.billNumber);
        
        // Show success visual feedback
        const billNumberInput = document.getElementById('bill_number');
        billNumberInput.style.borderColor = '#27ae60';
        billNumberInput.style.backgroundColor = '#f8fff9';
        
        setTimeout(() => {
          billNumberInput.style.borderColor = '';
          billNumberInput.style.backgroundColor = '';
        }, 2000);
        
        await showMessage('success', 'Generated!', `New bill number ${result.billNumber} has been generated.`);
      } else {
        const errorData = await response.json();
        console.error('‚ùå Failed to generate bill number:', errorData);
        await showMessage('error', 'Error', `Failed to generate bill number: ${errorData.error}`);
      }
    } catch (error) {
      console.error('‚ùå Error generating bill number:', error);
      await showMessage('error', 'Error', `Error generating bill number: ${error.message}`);
    }
  }

  // Make functions available globally
  window.logout = logout;
  window.generateBillNumber = generateBillNumber;
</script>
