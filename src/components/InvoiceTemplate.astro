---
import type { Bill } from '../config/database';

interface Props {
  bill: Bill;
  companyInfo: any;
}

const { bill, companyInfo } = Astro.props;

// Calculate totals
const subtotal = bill.items.reduce((sum, item) => sum + item.total_price, 0);
const cgstAmount = (subtotal * bill.cgst_percentage) / 100;
const sgstAmount = (subtotal * bill.sgst_percentage) / 100;
const igstAmount = (subtotal * bill.igst_percentage) / 100;
const totalTax = cgstAmount + sgstAmount + igstAmount;
const discountAmount = (subtotal * (bill.discount_percentage || 0)) / 100;
const finalTotal = subtotal + totalTax - discountAmount;

// Convert number to words (simplified version)
function numberToWords(num: number): string {
  const ones = ['', 'ONE', 'TWO', 'THREE', 'FOUR', 'FIVE', 'SIX', 'SEVEN', 'EIGHT', 'NINE'];
  const teens = ['TEN', 'ELEVEN', 'TWELVE', 'THIRTEEN', 'FOURTEEN', 'FIFTEEN', 'SIXTEEN', 'SEVENTEEN', 'EIGHTEEN', 'NINETEEN'];
  const tens = ['', '', 'TWENTY', 'THIRTY', 'FORTY', 'FIFTY', 'SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY'];
  
  if (num === 0) return 'ZERO';
  
  function convertHundreds(n: number): string {
    let result = '';
    if (n >= 100) {
      result += ones[Math.floor(n / 100)] + ' HUNDRED ';
      n %= 100;
    }
    if (n >= 20) {
      result += tens[Math.floor(n / 10)] + ' ';
      n %= 10;
    } else if (n >= 10) {
      result += teens[n - 10] + ' ';
      return result;
    }
    if (n > 0) {
      result += ones[n] + ' ';
    }
    return result;
  }
  
  const crores = Math.floor(num / 10000000);
  const lakhs = Math.floor((num % 10000000) / 100000);
  const thousands = Math.floor((num % 100000) / 1000);
  const hundreds = num % 1000;
  
  let result = '';
  if (crores) result += convertHundreds(crores) + 'CRORE ';
  if (lakhs) result += convertHundreds(lakhs) + 'LAKH ';
  if (thousands) result += convertHundreds(thousands) + 'THOUSAND ';
  if (hundreds) result += convertHundreds(hundreds);
  
  return result.trim() + ' RUPEES ONLY';
}

const totalInWords = numberToWords(Math.floor(finalTotal));
---

<div class="invoice-container">
  <div class="invoice-header">
    <div class="header-top">
      <span class="duplicate-label">ORIGINAL / DUPLICATE / EXTRA</span>
    </div>
    
    <div class="company-section">
      <div class="logo-section">
        <div class="logo-placeholder">SC</div>
      </div>
      <div class="company-details">
        <h1>SHAGOON SEATING CHAIR</h1>
        <p class="subtitle">(MFG. OF EXCLUSIVE CHAIR, SOFA, S.S POWDER COATED FURNITURE)</p>
        <div class="address">
          <p>{companyInfo?.address || 'GALA NO.07, KAUSHALYA RAMKARAN KEVET CHAWL, NEAR PRAVASI INDUSTRIAL ESTATE,'}</p>
          <p>2ND MARK DORIAN ESTATE, MULUND LINK ROAD, GOREGAON EAST, MUMBAI-400063,</p>
          <p>MAHARASHTRA Ph.: MOB.:- {companyInfo?.phone || '+91 9867071332/9769956235'}, Email:{companyInfo?.email || 'shagoonchair@gmail.com'}</p>
        </div>
      </div>
    </div>
  </div>

  <div class="invoice-info">
    <div class="customer-info">
      <div class="to-section">
        <strong>To,</strong><br>
        {bill.customer_name}
        {bill.customer_code && <> (Code: {bill.customer_code})</>}<br>
        {bill.customer_address}
        {bill.customer_phone && <><br>MOB NO. {bill.customer_phone}</>}
        {bill.customer_gst_number && <><br>GST NO. NO {bill.customer_gst_number}</>}
        <br>STATE- MAHARASHTRA &nbsp;&nbsp;&nbsp;&nbsp; CODE- 27
      </div>
      
      {bill.vendor_code && 
        <div class="vendor-code">
          <strong>VENDOR CODE :</strong> {bill.vendor_code}
        </div>
      }
    </div>

    <div class="invoice-details">
      <div class="invoice-number">
        <strong>INVOICE No: {bill.bill_number}</strong> &nbsp;&nbsp;&nbsp; <strong>Date: {new Date(bill.invoice_date).toLocaleDateString('en-GB')}</strong>
      </div>
      <div class="challan-info">
        <strong>CHALLAN No.</strong> {bill.challan_number || '--'} &nbsp;&nbsp;&nbsp;&nbsp; <strong>Date :</strong> {bill.challan_date ? new Date(bill.challan_date).toLocaleDateString('en-GB') : '--'}
      </div>
      <div class="po-info">
        <strong>P.O. No.</strong> {bill.po_number || '--'}<br>
        <strong>Date :</strong> {bill.po_date ? new Date(bill.po_date).toLocaleDateString('en-GB') : '--'}
      </div>
      <div class="dispatch-info">
        <strong>DESPATCH</strong><br>
        <strong>DETAILS :</strong> {bill.dispatch_details || '--'}
      </div>
    </div>
  </div>

  {bill.hsn_code && 
    <div class="hsn-section">
      <strong>HSN CODE :</strong> {bill.hsn_code}
    </div>
  }

  <table class="items-table">
    <thead>
      <tr>
        <th>SR.</th>
        <th>DESCRIPTION</th>
        <th colspan="2">UNIT PRICE</th>
        <th>QTY</th>
        <th colspan="2">AMOUNT</th>
      </tr>
      <tr class="subheader">
        <th></th>
        <th></th>
        <th>Rs.</th>
        <th>Ps.</th>
        <th></th>
        <th>Rs.</th>
        <th>Ps.</th>
      </tr>
    </thead>
    <tbody>
      {bill.items.map((item, index) => (
        <tr key={index}>
          <td>{item.sr_no}</td>
          <td>{item.product_name}. {item.product_description && <br><small>{item.product_description}</small>}</td>
          <td class="price-rs">{Math.floor(item.unit_price)}</td>
          <td class="price-ps">{String((item.unit_price % 1) * 100).padStart(2, '0')}</td>
          <td>{item.quantity}</td>
          <td class="amount-rs">{Math.floor(item.total_price)}</td>
          <td class="amount-ps">{String((item.total_price % 1) * 100).padStart(2, '0')}</td>
        </tr>
      ))}
      
      <!-- Empty rows for spacing -->
      {Array.from({ length: 8 - bill.items.length }, (_, i) => (
        <tr key={`empty-${i}`}>
          <td>&nbsp;</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      ))}
      
      <tr class="subtotal-row">
        <td colspan="5"><strong>TOTAL AMOUNT BEFORE TAX</strong></td>
        <td class="amount-rs"><strong>{Math.floor(subtotal)}</strong></td>
        <td class="amount-ps"><strong>{String((subtotal % 1) * 100).padStart(2, '0')}</strong></td>
      </tr>
    </tbody>
  </table>

  <div class="tax-calculation">
    <div class="tax-left">
      <div class="tax-row">
        <span>CGST@{bill.cgst_percentage}%</span>
        <span class="tax-amount">{Math.floor(cgstAmount)} {String((cgstAmount % 1) * 100).padStart(2, '0')}</span>
      </div>
      <div class="tax-row">
        <span>SGST@{bill.sgst_percentage}%</span>
        <span class="tax-amount">{Math.floor(sgstAmount)} {String((sgstAmount % 1) * 100).padStart(2, '0')}</span>
      </div>
      <div class="tax-row">
        <span>IGST @ {bill.igst_percentage}%</span>
        <span class="tax-amount">{Math.floor(igstAmount)} {String((igstAmount % 1) * 100).padStart(2, '0')}</span>
      </div>
      <div class="total-row">
        <span><strong>TOTAL Rs.</strong></span>
        <span class="total-amount"><strong>{Math.floor(finalTotal)} {String((finalTotal % 1) * 100).padStart(2, '0')}</strong></span>
      </div>
    </div>
  </div>

  <div class="amount-words">
    <strong>TOTAL.</strong> &nbsp;&nbsp;&nbsp; {totalInWords}.
  </div>

  <div class="footer-section">
    <div class="bank-details">
      <div class="bank-info">
        <strong>Bank Name :- {bill.bank_details?.bank_name || 'INDIAN BANK'}</strong><br>
        <strong>Bank A/c :- {bill.bank_details?.account_number || '641205735S'}</strong><br>
        <strong>Bank Branch: {bill.bank_details?.branch || 'MALAD EAST'}</strong><br>
        <strong>Bank IFSC :- {bill.bank_details?.ifsc_code || 'IDIB000M202'}</strong><br>
        <strong>Type of A/C: {bill.bank_details?.account_type || 'CURRENT A/C'}</strong>
      </div>
      
      <div class="terms-conditions">
        <strong>TERM AND CONDITION</strong><br>
        <ul>
          <li>Price including fabrics @10% party will have to give Two alternative.</li>
          <li>Inspection prior to dispatch if desire will be at our factory premise.</li>
          <li>50% advance against manufacturing order & balance against delivery.</li>
          <li>Warranty period 12 Months against manufacturing defect.</li>
          <li>Payment of the bill should be made within one month of bill Dated.</li>
          <li>Interest will be charged @ 24% on all accounts remaining unpaid after credit time.</li>
        </ul>
      </div>
    </div>

    <div class="signature-section">
      <div class="gst-info">
        <strong>GST No. : {companyInfo?.gst_number || '27ASQPG8588M1ZQ'}</strong><br>
        <strong>PAN NO. : {companyInfo?.pan_number || 'ASQPG8588M'}</strong>
      </div>
      
      <div class="signature-area">
        <strong>For SHAGOON SEATING CHAIR</strong><br><br><br>
        <strong>PROPRIETOR</strong>
      </div>
    </div>

    <div class="payment-note">
      <strong>PAYMENT ONLY BY CROSSED CHEQUES / DD PAYABLE IN MUMBAI</strong>
    </div>
  </div>
</div>

<style>
.invoice-container {
  max-width: 21cm;
  margin: 0 auto;
  padding: 1cm;
  background: white;
  font-family: Arial, sans-serif;
  font-size: 11px;
  line-height: 1.2;
  border: 2px solid #000;
}

.invoice-header {
  border-bottom: 2px solid #000;
  margin-bottom: 10px;
}

.header-top {
  text-align: right;
  font-weight: bold;
  margin-bottom: 10px;
}

.company-section {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
}

.logo-placeholder {
  width: 80px;
  height: 80px;
  border: 2px solid #000;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: bold;
  background: #f0f0f0;
}

.company-details h1 {
  font-size: 20px;
  font-weight: bold;
  margin: 0 0 5px 0;
  text-align: center;
}

.subtitle {
  font-size: 10px;
  text-align: center;
  margin: 0 0 8px 0;
}

.address {
  font-size: 9px;
  line-height: 1.3;
}

.invoice-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}

.customer-info {
  width: 60%;
}

.to-section {
  border: 1px solid #000;
  padding: 8px;
  margin-bottom: 5px;
  min-height: 100px;
}

.vendor-code {
  padding: 5px 0;
}

.invoice-details {
  width: 35%;
  border: 1px solid #000;
  padding: 8px;
}

.invoice-number, .challan-info, .po-info, .dispatch-info {
  margin-bottom: 8px;
  border-bottom: 1px solid #ccc;
  padding-bottom: 5px;
}

.hsn-section {
  text-align: right;
  margin-bottom: 5px;
  padding: 5px;
  border: 1px solid #000;
}

.items-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 10px;
}

.items-table th,
.items-table td {
  border: 1px solid #000;
  padding: 4px;
  text-align: center;
  vertical-align: top;
}

.items-table th {
  background: #f5f5f5;
  font-weight: bold;
}

.items-table td:nth-child(2) {
  text-align: left;
  max-width: 200px;
}

.price-rs, .amount-rs {
  text-align: right;
  border-right: none !important;
}

.price-ps, .amount-ps {
  text-align: left;
  border-left: none !important;
  width: 30px;
}

.subtotal-row {
  background: #f9f9f9;
}

.tax-calculation {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 10px;
}

.tax-left {
  width: 300px;
}

.tax-row {
  display: flex;
  justify-content: space-between;
  padding: 2px 0;
  border-bottom: 1px solid #ccc;
}

.total-row {
  display: flex;
  justify-content: space-between;
  padding: 5px 0;
  border-top: 2px solid #000;
  border-bottom: 2px solid #000;
  font-weight: bold;
}

.amount-words {
  border: 1px solid #000;
  padding: 8px;
  margin-bottom: 10px;
  background: #f9f9f9;
}

.footer-section {
  border-top: 1px solid #000;
  padding-top: 10px;
}

.bank-details {
  display: flex;
  gap: 20px;
  margin-bottom: 15px;
}

.bank-info {
  width: 40%;
  border: 1px solid #000;
  padding: 8px;
}

.terms-conditions {
  width: 55%;
  border: 1px solid #000;
  padding: 8px;
}

.terms-conditions ul {
  margin: 5px 0;
  padding-left: 15px;
}

.terms-conditions li {
  font-size: 9px;
  margin-bottom: 2px;
}

.signature-section {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  margin-bottom: 10px;
}

.signature-area {
  text-align: center;
  border: 1px solid #000;
  padding: 10px 20px;
  height: 80px;
}

.gst-info {
  border: 1px solid #000;
  padding: 8px;
}

.payment-note {
  text-align: center;
  font-weight: bold;
  border: 2px solid #000;
  padding: 8px;
  background: #f0f0f0;
}

@media print {
  .invoice-container {
    border: none;
    padding: 0;
    box-shadow: none;
  }
}
</style>
